<html>
<head>
<title>Crash Rates (Telemetry)</title>
<style>

body {
  font-family: sans-serif;
}

table {
  border-collapse: collapse;
  border-spacing: 0 0;
  border: 1px solid black;
}

td {
  border: 1px solid black;
  padding: 0.1em 0.33em;
}

td.type-float {
  text-align: right;
}

thead {
  font-weight: bold;
}
</style>
</head>
<body>
<h1>Stability Dashboard</h1>
<h5>Analyzed date: <span id="analyzed-date"></span></h5>
<h3>Firefox Desktop</h3>
<table id="data-table">
  <thead>
    <tr>
      <td>Channel</td>
      <td>Nightly</td>
      <td>Aurora</td>
      <td>Beta</td>
      <td>Release</td>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<p>Cells are of the form <em>Rate (X%)</em> where:</p>
<dt><em>Rate</em></dt>
<dd>- is the number of that type of crash divided by the usage_khours (or, in the case of usage_khours, is just the number of usage_khours)<dd>
<dt><em>(X%)</em></dt>
<dd>- is the percent change in the number (not the rate) of that crash vs. last week's number (not rate) of that crash</dd>
<p>Since crash rates are <em>#crashes / usage_khours</em> a low <em>(X%)</em> in <em>usage_khours</em> can result in an inflation of crash rates.</p>
<p>To estimate how much of an inflation, take a relatively-stable crash type (like <em>P</em>) and compare its <em>(X%)</em> to <em>usage_khours</em>'.</p>
<p>As of yet, no model has been developed to do this properly, so YMMV.</p>
<script>
var formatHours = function(hours) {
  // values are kilo-usage-hours and range in value from, say,
  // 24.2 (7% of nightly) to
  // 813,816.57 (~100% of release)

  // So... optional "K"?

  hours = Number(hours);
  let suffix = '';
  if (hours < 2000) {
    // do nothing.
  } else {
    hours = hours / 1000;
    suffix = 'k';
  }
  return Number(hours).toFixed(Math.max(0, 2 - Math.ceil(Math.log10(hours)))) + suffix;
}

var xhr = new XMLHttpRequest();
xhr.addEventListener("load", function() {

  let data = undefined;
  try {
    data  = JSON.parse(this.responseText).query_result.data;
  } catch (e) {
    console.error("Failed a JSON parse");
    console.error(e.message);
  }

  let table = document.getElementById("data-table");
  let theadRow = table.getElementsByTagName("tr")[0];
  let tbody = table.getElementsByTagName("tbody")[0];

  let map = {};
  data.rows.forEach((row) => {
    if (!(row.activity_date in map)) {
      map[row.activity_date] = {};
    }
    map[row.activity_date][row.channel] = row;
  });
  let latestDate = Object.keys(map).sort((a, b) => a < b ? 1 : (a > b ? -1 : 0))[0];

  let weekAgoDate = new Date(latestDate);
  weekAgoDate.setDate(weekAgoDate.getDate() - 7);
  weekAgoDate = weekAgoDate.toISOString().slice(0, 10);

  if (!map[weekAgoDate]) {
    console.error("No data from a week ago?!");
  }

  document.getElementById("analyzed-date").textContent = latestDate;

  data.columns.forEach((column) => {
    if (['activity_date', 'channel'].includes(column.name)) {
      return;
    }
    let row = document.createElement("tr");
    let cell = document.createElement("td");
    cell.textContent = column.friendly_name;
    row.appendChild(cell);
    tbody.appendChild(row);
    ["nightly", "aurora", "beta", "release"].forEach((channel) => {
      cell = document.createElement("td");
      cell.className = "type-" + column.type;

      // if a number, format it
      if (column.type === "float") {
        if (column.name === "usage_khours") {
          let hours = map[latestDate][channel][column.name];
          let percent = Number(Number(hours) / Number(map[weekAgoDate][channel][column.name]) * 100).toFixed(1);
          cell.textContent = formatHours(hours) + " (" + percent + "%)";
        } else {
          let crashes = map[latestDate][channel][column.name];
          let percent = Number(Number(crashes) / Number(map[weekAgoDate][channel][column.name]) * 100).toFixed(1);
          let usage = map[latestDate][channel]["usage_khours"];
          cell.textContent = Number(crashes / usage).toFixed(2) + " (" + percent + "%)";
        }
      } else {
        cell.textContent = map[latestDate][channel][column.name];
      }
      row.appendChild(cell);
    });
  });

});
xhr.addEventListener("error", () => {
  console.error("ERROR");
});
xhr.open("GET", "https://sql.telemetry.mozilla.org/api/queries/1092/results.json?api_key=f7dac61893e040ca59c76fd616f082479e2a1c85");
xhr.send();
</script>
</body>
</html>
