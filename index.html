<html>
<head>
<title>Crash Rates (Telemetry)</title>
<style>

body {
  font-family: sans-serif;
}

table {
  border-collapse: collapse;
  border-spacing: 0 0;
  border: 1px solid black;
}

td {
  border: 1px solid black;
  padding: 0.1em 0.33em;
}

td.type-float {
  text-align: right;
}

thead {
  font-weight: bold;
}
</style>
</head>
<body>
<h1>Stability Dashboard</h1>
<h5>Analyzed date: <span id="analyzed-date"></span></h5>
<h3>Firefox Desktop</h3>
<p><em>(X%)</em> means the current value is X% of last week's value.</p>
<table id="data-table">
  <thead>
    <tr>
      <td>Channel</td>
      <td>Nightly</td>
      <td>Aurora</td>
      <td>Beta</td>
      <td>Release</td>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<script>
var xhr = new XMLHttpRequest();
xhr.addEventListener("load", function() {

  let data = undefined;
  try {
    data  = JSON.parse(this.responseText).query_result.data;
  } catch (e) {
    console.error("Failed a JSON parse");
    console.error(e.message);
  }

  let table = document.getElementById("data-table");
  let theadRow = table.getElementsByTagName("tr")[0];
  let tbody = table.getElementsByTagName("tbody")[0];

  let map = {};
  data.rows.forEach((row) => {
    if (!(row.activity_date in map)) {
      map[row.activity_date] = {};
    }
    map[row.activity_date][row.channel] = row;
  });
  let latestDate = Object.keys(map).sort((a, b) => a < b ? 1 : (a > b ? -1 : 0))[0];

  let weekAgoDate = new Date(latestDate);
  weekAgoDate.setDate(weekAgoDate.getDate() - 7);
  weekAgoDate = weekAgoDate.toISOString().slice(0, 10);

  if (!map[weekAgoDate]) {
    console.error("No data from a week ago?!");
  }

  document.getElementById("analyzed-date").textContent = latestDate;

  data.columns.forEach((column) => {
    if (['activity_date', 'channel'].includes(column.name)) {
      return;
    }
    let row = document.createElement("tr");
    let cell = document.createElement("td");
    cell.textContent = column.friendly_name;
    row.appendChild(cell);
    tbody.appendChild(row);
    ["nightly", "aurora", "beta", "release"].forEach((channel) => {
      cell = document.createElement("td");
      cell.className = "type-" + column.type;

      // if a number, format it
      if (column.type === "float") {
        if (column.name === "usage_khours") {
          let hours = map[latestDate][channel][column.name];
          let percent = Number(Number(hours) / Number(map[weekAgoDate][channel][column.name]) * 100).toFixed(1);
          cell.textContent = Number(hours).toFixed(2) + " (" + percent + "%)";
        } else {
          let crashes = map[latestDate][channel][column.name];
          let percent = Number(Number(crashes) / Number(map[weekAgoDate][channel][column.name]) * 100).toFixed(1);
          let usage = map[latestDate][channel]["usage_khours"];
          cell.textContent = Number(crashes / usage).toFixed(2) + " (" + percent + "%)";
        }
      } else {
        cell.textContent = map[latestDate][channel][column.name];
      }
      row.appendChild(cell);
    });
  });

});
xhr.addEventListener("error", () => {
  console.error("ERROR");
});
xhr.open("GET", "https://sql.telemetry.mozilla.org/api/queries/1092/results.json?api_key=f7dac61893e040ca59c76fd616f082479e2a1c85");
xhr.send();
</script>
</body>
</html>
